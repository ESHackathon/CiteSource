---
title: "Plot Sandbox"

author: ""

date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plot Sandbox}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 10,
  warning = FALSE
)
```
## About this vignette

This vignette is a bit of a sandbox for the experimentation with plots! Currently it is using the working example data (same data used in the "Source Analysis Across Screening Phases" vignette). The focus is on plots that we are exploring.

If you have any questions, feedback, ideas, etc. about this vignette or others be sure to check out our discussion board on github! https://github.com/ESHackathon/CiteSource/discussions/100

## 1. Initial setup

```{r, results = FALSE, message=FALSE}
#Load the necessary libraries
library(CiteSource)
library(dplyr)
library(ggplot2)

#Import citation files from a folder
citation_files <- list.files(path = file.path("../vignettes/working_example_data"), pattern = "\\.ris", full.names = TRUE)
#Print citation_files to double check the order in which R imported our files.
citation_files
# Set the path to the directory containing the citation files
file_path <- "../vignettes/working_example_data/"

metadata_tbl <- tibble::tribble(
  ~files,           ~cite_sources, ~cite_labels, 
   "AGRIS.ris",      "AGRIS",       "search",    
   "CAB.ris",        "CAB",         "search",    
   "EconLit.ris",    "EconLit",     "search",    
   "Final.ris",       NA,           "final",     
   "GreenFile.ris",  "GreenFile",   "search",    
   "McK.ris",        "Method1",     "search",    
   "RM.ris",         "Method2",     "search",    
   "TiAb.ris",        NA,           "screened",  
   "WoS_early.ris",  "WoS",         "search",    
   "WoS_later.ris",  "WoS",         "search"
) %>% 

dplyr::mutate(files = paste0(file_path, files))
citations <- read_citations(metadata = metadata_tbl)
# Deduplication & Identifying Crossover Records
unique_citations <- dedup_citations(citations)
# Count number of unique and non-unique citations from different sources and labels
n_unique <- count_unique(unique_citations)
# Create dataframe indicating occurrence of records across sources
source_comparison <- compare_sources(unique_citations, comp_type = "sources")
```
## 2. New slated for implementation
### New table to show internal deduplication
```{r}
library(gt)
library(gtExtras)
# Function to count occurrences of each database
count_sources <- function(df, db_colname) {
    db_counts <- df %>%
        dplyr::pull(!!sym(db_colname)) %>%
        strsplit(", ") %>%
        lapply(unique) %>%  
        unlist() %>%
        trimws() %>%
        table() %>%
        as.data.frame()
    
    colnames(db_counts) <- c("Source", "count")
    
    return(db_counts)
}

# Calculate distinct record count for each database
distinct_count <- count_sources(unique_citations, "cite_source")
colnames(distinct_count) <- c("Source", "Distinct Records")

# Count the citations in the uploaded .ris data and remove blank rows
initial_citations_count <- count_sources(citations, "cite_source")
colnames(initial_citations_count) <- c("Source", "Records Imported")

# Combine the counts into one table
citation_counts <- dplyr::left_join(initial_citations_count, distinct_count, by = "Source")

# Convert the necessary columns to numeric
citation_counts$`Distinct Records` <- as.numeric(citation_counts$`Distinct Records`)
citation_counts$`Records Imported` <- as.numeric(citation_counts$`Records Imported`)

# Convert the Source column to character
citation_counts$Source <- as.character(citation_counts$Source)

# Calculate totals
totals <- c("Total", 
            sum(citation_counts$`Records Imported`, na.rm = TRUE),
            sum(citation_counts$`Distinct Records`, na.rm = TRUE)
)

# Add the total row
citation_counts <- rbind(citation_counts, totals)

# Generate the final table
citation_counts %>%
    gt(rowname_col = "Source") %>%
    tab_header(title = "Record Counts") %>%
    cols_label(
        `Records Imported` = "Records Imported¹",
        `Distinct Records` = "Distinct Records²"
    ) %>%
    tab_source_note(
        source_note = md(c(
            "¹ Number of records imported from each source.",
            "² Number of records after internal source deduplication"
        ))
    )%>%
    gt_theme_538()
```
### New Updated Search Summary Table
```{r}
library(gt)
library(gtExtras)
# Function to count occurrences of each database
count_sources <- function(df, db_colname) {
    db_counts <- df %>%
        dplyr::pull(!!sym(db_colname)) %>%
        strsplit(", ") %>%
        lapply(unique) %>%  
        unlist() %>%
        trimws() %>%
        table() %>%
        as.data.frame()
    
    colnames(db_counts) <- c("Source", "count")
    
    return(db_counts)
}

# Calculate Distinct Records count for each database
distinct_count <- count_sources(unique_citations, "cite_source")
colnames(distinct_count) <- c("Source", "Distinct Records")

# Count the citations in the uploaded .ris data and remove blank rows
initial_citations_count <- count_sources(citations, "cite_source")
colnames(initial_citations_count) <- c("Source", "Records Imported")

# Count the citations in the n_unique data, remove blank rows, and exclude rows without 'search' in cite_label
n_unique_citations_count <- n_unique %>%
    dplyr::filter(cite_label == "search") %>%
    dplyr::group_by(cite_source) %>%
    dplyr::summarise(`Unique records` = sum(unique)) %>%
    dplyr::filter(cite_source != "") %>%
    dplyr::arrange(cite_source) %>%
    dplyr::rename(Source = cite_source)

# Combine the counts into one table
citation_counts <- dplyr::left_join(initial_citations_count, distinct_count, by = "Source") %>%
    dplyr::left_join(n_unique_citations_count, by = "Source")

# Add the "Non-unique Records" column directly
citation_counts <- citation_counts %>%
    dplyr::mutate(`Non-unique Records` = `Distinct Records` - `Unique records`)

# Convert the necessary columns to numeric
citation_counts$`Distinct Records` <- as.numeric(citation_counts$`Distinct Records`)
citation_counts$`Records Imported` <- as.numeric(citation_counts$`Records Imported`)
citation_counts$`Unique records` <- as.numeric(citation_counts$`Unique records`)
citation_counts$`Non-unique Records` <- as.numeric(citation_counts$`Non-unique Records`)

# Add the calculations
citation_counts <- citation_counts %>%
    dplyr::mutate(`Source Contribution %` = `Distinct Records` / sum(`Distinct Records`, na.rm = TRUE),
                  `Source Unique Contribution %` = `Unique records` / sum(`Unique records`, na.rm = TRUE),
                  `Source Unique %` = `Unique records` / `Distinct Records`)

citation_counts <- citation_counts %>%
    dplyr::mutate(
        `Source Contribution %` = as.numeric(`Source Contribution %`),
        `Source Unique Contribution %` = as.numeric(`Source Unique Contribution %`),
        `Source Unique %` = as.numeric(`Source Unique %`)
    ) %>%
    dplyr::mutate(
        `Source Contribution %` = scales::percent(`Source Contribution %`, accuracy = 0.1),
        `Source Unique Contribution %` = scales::percent(`Source Unique Contribution %`, accuracy = 0.1),
        `Source Unique %` = scales::percent(`Source Unique %`, accuracy = 0.1)
    )

# Calculate totals
totals <- c("Total", 
            sum(citation_counts$`Records Imported`, na.rm = TRUE),
            sum(citation_counts$`Distinct Records`, na.rm = TRUE),
            sum(citation_counts$`Unique records`, na.rm = TRUE),
            sum(citation_counts$`Non-unique Records`, na.rm = TRUE),
            "-", "-", "-")

# Add the total row
citation_counts <- rbind(citation_counts, totals)

citation_counts %>%
    gt(rowname_col = "Source") %>%
    tab_header(title = "Record Counts") %>%
    cols_label(
        `Records Imported` = "Records Imported¹",
        `Distinct Records` = "Distinct Records²",
        `Unique records` = "Unique records³",
        `Non-unique Records` = "Non-unique Records⁴",
        `Source Contribution %` = "Records Contributed %⁵",
        `Source Unique Contribution %` = "Unique Records Contributed %⁶",
        `Source Unique %` = "Unique Records %⁷"
    ) %>%
    tab_source_note(
        source_note = md(c(
            "¹ Number of raw records imported from each database.",
            "² Number of records after internal source deduplication",
            "³ Number of records not found in another source.",
            "⁴ Number of records found in at least one other source.",
            "⁵ Percent distinct records contributed to the total number of distinct records.",
            "⁶ Percent of unique records contributed to the total unique records.",
            "⁷ Percentage of records that were unique from each source."
        ))
    )%>%
    gt_theme_538()

```
### New precision/sensitivity table
```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(gt)
library(gtExtras)

# Function to count occurrences of each source in the 'Screened' and 'Final' phases
count_source_phase <- function(source_phase_df) {
    source_phase_df <- source_phase_df %>%
        tidyr::separate_rows(cite_source, sep = ",") %>%
        tidyr::separate_rows(cite_label, sep = ",") %>%
        dplyr::mutate(cite_source = stringr::str_trim(cite_source),
                      cite_label = stringr::str_trim(cite_label)) %>%
        dplyr::filter(cite_source != "unknown") %>%
        dplyr::mutate(screened = ifelse(cite_label == "screened", 1, 0),
                      final = ifelse(cite_label == "final", 1, 0)) %>%
        dplyr::group_by(cite_source) %>%
        dplyr::summarise(screened = sum(screened),
                         final = sum(final),
                         .groups = "drop") %>%
        dplyr::rename(Source = cite_source)
    
    return(source_phase_df)
}

source_phase <- count_source_phase(unique_citations)

# Function to count occurrences of each database
count_sources <- function(source_phase_df, db_colname) {
    db_counts <- source_phase_df %>%
        dplyr::pull(rlang::sym(db_colname)) %>%
        strsplit(", ") %>%
        lapply(unique) %>%  
        unlist() %>%
        trimws() %>%
        table() %>%
        as.data.frame()
    
    colnames(db_counts) <- c("Source", "count")
    
    return(db_counts)
}

distinct_count <- count_sources(unique_citations, "cite_source")
colnames(distinct_count) <- c("Source", "Distinct Records")

distinct_count$`Distinct Records` <- as.numeric(distinct_count$`Distinct Records`)
distinct_count$Source <- as.character(distinct_count$Source)

# Combine the results
combined_counts <- dplyr::left_join(distinct_count, source_phase, by = "Source")

# Replace NA values with 0
combined_counts[is.na(combined_counts)] <- 0

# Calculate Precision
combined_counts <- combined_counts %>%
    dplyr::mutate(Precision = ifelse(`Distinct Records` != 0, round((final / `Distinct Records`) * 100, 2), 0))  # Multiply by 100 and round

# Calculate Recall manually in a loop
total_final <- sum(combined_counts$final)
for(i in 1:nrow(combined_counts)) {
    combined_counts$Recall[i] <- round((combined_counts$final[i] / total_final) * 100, 2)  # Multiply by 100 and round
}

# Calculate totals
totals <- c("Total", 
            sum(combined_counts$`Distinct Records`, na.rm = TRUE),
            paste0(sum(citations$cite_label == "screened"), "⁶"),
            paste0(sum(citations$cite_label == "final"), "⁷"),
            "-",  # Precision total doesn't make sense
            "-")  # Recall total doesn't make sense

# Add the total row
combined_counts <- rbind(combined_counts, totals)

# Remove the 'unknown' row - this should be corrected and unnecessary soon
combined_counts <- combined_counts %>%
    dplyr::filter(Source != "unknown")

# Generate the final table
combined_counts %>%
    gt::gt(rowname_col = "Source") %>%
    gt::tab_header(title = "Record Counts & Precision/Sensitivity") %>%
    gt::cols_label(
        `Distinct Records` = "Distinct Records¹",
        screened = "Screened Included²",
        final = "Final Included³",
        Precision = "Precision⁴",
        Recall = "Sensitivity/Recall⁵"
    ) %>%
   gt::cols_align(
        align = "right",
        columns = c(screened, final)
    ) %>%
    gt::tab_source_note(
        source_note = gt::md(c(
            "¹ Number of source specific unique records",
            "² Records included after title/abstract screening",
            "³ Records included after full text screening",
            "⁴ Precision = Final Included / Distinct Records",
            "⁵ Sensitivity/Recall = Final Included / Total Final Included",
            "⁶ Number of records included after title/abstract screening",
            "⁷ Number of records included after full text screening"
        ))
    )%>%
    gtExtras::gt_theme_538()


```

##3. Current plots
### Heatmaps
```{r}
my_heatmap <- plot_source_overlap_heatmap(source_comparison)

my_heatmap

# Plot overlap as a heatmap matrix as percentage

my_heatmap_percent <- plot_source_overlap_heatmap(source_comparison, plot_type = "percentages")

my_heatmap_percent

```

### Upset plot
```{r}
# Citation duplication across multitiple resources

my_upset_plot <- plot_source_overlap_upset(source_comparison, decreasing = c(TRUE, TRUE))

my_upset_plot
```

### Unique/Crossover Bar Plot
```{r}
# Unique vs. Duplicate sources across Search/TiAb Screening/Final Inclusion

my_contributions <- plot_contributions(n_unique,
  center = TRUE,
  bar_order = c("search", "Screened", "Final")
)

my_contributions
```
##4. Prep for expirimental plots
```{r}
#Get unique records from each source and add bibliographic data
unique_AGRIS <- n_unique %>% 
  dplyr::filter(cite_source=="AGRIS", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

unique_CAB <- n_unique %>% 
  dplyr::filter(cite_source=="CAB", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

unique_EconLit <- n_unique %>% 
  dplyr::filter(cite_source=="EconLit", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

unique_WoS <- n_unique %>% 
  dplyr::filter(cite_source=="WoS", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

unique_Method1 <- n_unique %>% 
  dplyr::filter(cite_source=="Method1", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

unique_Method2 <- n_unique %>% 
  dplyr::filter(cite_source=="Method2", unique == TRUE) %>%
  inner_join(unique_citations, by = "duplicate_id")

all_unique <- bind_rows(unique_AGRIS, unique_CAB, unique_EconLit,
                        unique_WoS, unique_Method1, unique_Method2)

```

##.5 Expirimental plots
### Publication year bar plots
```{r}

# Filter the "all_unique" dataset to only include records with a valid year
# Create a new column to represent the year
# Group the data by source and year and calculate the count of records for each group
year_data <- all_unique %>% 
  dplyr::mutate(year = as.numeric(year)) %>%  # Convert "year" column to numeric format
  dplyr::filter(!is.na(year) & year != "") %>%  # Remove rows where "year" is missing or empty
  group_by(cite_source.x, year) %>%  # Group data by "cite_source.x" and "year"
  summarise(count = n(), .groups = "drop")  # Calculate the number of records in each group

# Create a bar plot to visualize the filtered and grouped data
unique_yearplot <- ggplot(year_data, aes(x=year, y=count, fill = cite_source.x)) +
  geom_bar(position = "stack", stat = "identity") +  # Create a stacked bar plot with actual count values
  scale_x_continuous(breaks = seq(min(year_data$year), max(year_data$year), by = 5)) +  # Set x-axis breaks to every 5 years
  coord_cartesian(ylim = c(0, 950)) +  # Set y-axis limits to ensure all bars are visible
  xlab("Publication year") +  # Add x-axis label
  ylab("Unique records") +  # Add y-axis label
  labs(fill = "Source")  # Add legend label for the fill color

unique_yearplot
```

### interactive publication year bar plot
```{r}
# Creating an interactive plot with plotly
library(plotly)

unique_year_funplot <- ggplotly(unique_yearplot, tooltip = c("cite_source.x", "year", "count"), dynamicTicks = TRUE)

unique_year_funplot
```

### Sankey plot idea
```{r}
#further work needed to integrate Unique_citations into this plot, as this is very manual, but great as an example as to how the three custom fields can be visualized. In this case Strings/Sources/Timeline (Inclusion/Exclusion)

library(networkD3)

# Define nodes
nodes <- data.frame(
  name = c("AG 1", "AG 2", "AGRIS", 
           "CAB 1", "CAB 2", "CAB",
           "EL 1", "EL 2", "EconLit", 
           "WoS 1", "WoS 2", "WoS", 
           "Method 1", "Method 2", 
           "TI/AB Included", "Final Included", "Excluded", "NA"),
  id = 0:17
)

# Define links
links <- data.frame(
  source = c(0, 1, 3, 4, 6, 7, 9, 10),
  target = c(2, 2, 5, 5, 8, 8, 11, 11),
  value = c(100, 150, 100, 150, 100, 150, 100, 100)
)

# Add links for the second column nodes (including Method 1 and Method 2) flowing into TI/AB Included and Excluded
links <- rbind(links, data.frame(
  source = c(2, 5, 8, 11, 2, 5, 8, 11, 12, 12, 13, 13),
  target = c(14, 14, 14, 14, 16, 16, 16, 16, 14, 16, 14, 16),
  value = c(50, 50, 50, 50, 200, 200, 200, 150, 50, 50, 50, 50)
))

# Add links for TI/AB Included flowing into Final Included and Excluded
links <- rbind(links, data.frame(
  source = c(14),
  target = c(15),
  value = c(100)
))

links <- rbind(links, data.frame(
  source = c(14),
  target = c(16),
  value = c(200)
))

nodes <- rbind(nodes, data.frame(
  name = c("", ""),
  id = 17:18
))

links <- rbind(links, data.frame(
  source = c(17, 17),
  target = c(12, 13),
  value = c(NA, NA)
))



# Create Sankey diagram
sankey<-sankeyNetwork(
  Links = links,
  Nodes = nodes,
  Source = "source",
  Target = "target",
  Value = "value",
  NodeID = "name",
  units = "",
  fontSize = 12,
  nodeWidth = 20,
  iterations = 0
)
sankey
```

## 6. Expirimental source-specific tables
### Unique Journal Count per Source 
```{r}
library(gt)
#Exploritory Plot - The following table and functions are not yet integrated into CiteSource

# Create a function to group by journal, count unique citations, and arrange in descending order
# This function takes a data frame as input, and returns a processed data frame
process_journals <- function(data) {
  data %>%
    group_by(journal) %>%          # Group the data by journal
    summarise(count = n()) %>%
    dplyr::filter(journal != "") %>%  # Filter out any blank journal titles
    arrange(desc(count))             # Arrange the journals in descending order of count
}

# Process Journal Titles
AGRIS_journals <- process_journals(unique_AGRIS)
CAB_journals <- process_journals(unique_CAB) 
EconLit_journals <- process_journals(unique_EconLit) 
WoS_journals <- process_journals(unique_WoS)
Method1_journals <- process_journals(unique_Method1)
Method2_journals <- process_journals(unique_Method2)

# Create a function to display a gt table
# This function takes a data frame and a caption as input, and returns a gt table
display_gt_table <- function(data, caption) {
  data %>%
    gt() %>%
    tab_header(title = caption) %>%  # Set the table title to the provided caption
    cols_label(journal = "Journal", count = "Unique Citations") %>%  # Set column labels
    tab_options(
      table.width = px(600),
      table.font.size = px(12),
      heading.title.font.size = px(16),
      heading.subtitle.font.size = px(14)
    )                                   # Set table styling options
}
```

### Top 10 journals for each source 
```{r}
display_gt_table(CAB_journals[1:10, ], "Top 10 Journals by Unique Citations CAB")
```
```{r}

display_gt_table(WoS_journals[1:10, ], "Top 10 Journals by Unique Citations WoS")
```

##7. Current tables
### Citation Summary Table
```{r}
citation_summary_table(unique_citations, screening_label = c("screened", "final"))
```

### Citation Record Table
```{r}
# Citation Record Table

unique_citations %>%
  dplyr::filter(stringr::str_detect(cite_label, "final")) %>%
  record_level_table(return = "DT")

```


