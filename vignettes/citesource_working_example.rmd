---
title: "CiteSource - Short working example"

author: "Trevor Riley"

date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CiteSource - Example 2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 10,
 warning = FALSE
)
```

## About the package 

CiteSource provides users with the ability to deduplicate references while maintaining customizable metadata. Instead of the traditional deduplication method where records are removed and only one record is selected to be retained, CiteSource retains each duplicate record while merging metadata into a single main record. This main record maintains user-customized metadata in three fields, "cite_source", "cite_label" and "tag_naming". In the merging process, select metadata fields are also automatically compared (currently DOI & Abstract) and the most complete metadata is used in the main record.

## Installation
```{r eval = FALSE}
#Install the remotes packages to enable installation from GitHub
install.packages("remotes")
library(remotes)

#Install CiteSource
remotes::install_github("ESHackathon/CiteSource")
```

After installation, you can load the package.

```{r}
library(CiteSource)
```

## Import and read citation files

Users can import multiple RIS or bibtex files into CiteSource, which they can label with three custom metadata fields, Cite_Source, Cite_String, and Cite_Label. 

Using the Cite_Source field, which the user can label individual files with source information such as database or platform. Beyond source information, users may also use #the Cite_Source field to provide search results using various search methodologies. 

A second metadata field Cite_String can be used to specify another attribute or variable. For example, a use of Cite_Source and Cite_String may be to examine the unique and crossover citations that occur between databases, while simultaneously evaluating unique search string results. 

Finally, a third field Cite_Label can be used to apply yet another variable. This label was intended to be used in combination with the previous two, in order to track the inclusion or exclusion of citations over the course of title/abstract screening and full text screening.

### Indicate location files
```{r}
citation_files <- list.files(path=file.path("../tests/testthat/data", "working_example/short"), pattern = "\\.ris", full.names = TRUE)

citation_files
```


### Read citation files
Read citation files and store. Provide tags for each file with appropriate Cite_Source, Cite_String, or Cite_Label. Store these citations. Note: This vignette is the short a short version. Sources McK and RM represent a consolidation of multiple citation files, to see these citation files, view the long version of this vignette.

```{r}
citations <- read_citations(citation_files,
                           cite_sources = c("AGRIS", "CAB", "EconLit", NA, 
                                            "GreenFile", "McK", "RM", NA, "WoS", "WoSE"),
                            cite_labels = c("search","search", "search", "Final", 
                                            "search","search","search","Screened", "search","search"),
                            tag_naming = "best_guess")
```

## Deduplicate and identify crossover records

CiteSource allows users to merge duplicates while maintaining information in the cite_label and cite_source metadata field. Thus, information about the origin of the records is not lost in the deduplication process. 

```{r}
dedup_results <- dedup_citations(citations, merge_citations = TRUE)

unique_citations <- dedup_results$unique
```
### Count number of unique and non-unique citations from different sources and labels
```{r}
n_unique <- count_unique(unique_citations)
```

### Create dataframe indicating occurrence of records across sources
```{r}
source_comparison <- compare_sources(unique_citations, comp_type = "sources")
```

## Source & method analysis

When teams are selecting databases for inclusion in a review it can be extremely difficult to determine the best resources and determine the ROI in terms of the time it takes to apply searches. This is especially true in environmental research where research is often cross-disciplinary. By tracking where/how each citation was found, the evidence synthesis community could in turn track the efficacy of various databases and identify the most relevant resources as it relates to their research topic. This idea can be extended to search string comparison as well as strategy and methodology comparison.

### Plot overlap as a heatmap matrix
CiteSource performs citation analysis and deduplication within each source file, prior to comparing sources across source files. This heatmap shows the number of citations unique to that each source at the top of the source's column. The heatmap also provides a count of citations that were found at the intersection of each source. 

In this case you can see that the source tag McK only shows 2400 results, while the initial .ris file contained 2661 citations. This means that CiteSource identified 261 duplicate references within that citation list. The 2400 remaining citations then attributed to this source. Looking at the source Greenfile, we can see that the CiteSource did not find any duplicate citations within this source as both counts read 139.

CiteSource is more accurate in deduplicating references when complete metadata is provided. It is recommended that users provide the most full metadata as possible. Please not that citations in this vignette were stripped of their abstracts to avoid any copyright issues. 
```{r}
my_heatmap <- plot_source_overlap_heatmap(source_comparison)

my_heatmap 

```

### Plot overlap as a heatmap matrix as percentage
The following heatmap provides the an overview of the overlapping citations by percent of each source's count. For example the EconLit source contains 50 citations, of those 50 we can see on the previous heatmap that 8 of these citations were also in the source WoSE, which represents 16% of the citations from EconLit. On the other hand the same 8 citations only represent .3% of the total citations from WoSE. (currently this chart is set to display only whole numbers - we are considering changing this to display to the first decimal)
```{r}
my_heatmap_percent <- plot_source_overlap_heatmap(source_comparison, plot_type = "percentages")

my_heatmap_percent

```

### Plot overlap as an upset plot
```{r}
my_upset_plot <- plot_source_overlap_upset(source_comparison, decreasing = c(TRUE, TRUE))

my_upset_plot

```

## Analyzing records after screening

Once the title and abstract screening has been completed or once the final papers have been selected, users can analyze the contributions of each source or search method to these screening phases to better understand their impact on the review. By using the "cite_source" data along with the "cite_label" data, users can analyze the number of overlapping/unique records from each source or method.

### Assess contribution of sources by review stage
```{r}
my_contributions <- plot_contributions(n_unique, center = TRUE, 
                                       bar_order = c('search', 'Screened', 'Final'))

my_contributions

```

## Documentation and output

In addition to the above visualizations, it may be useful to export datasets for additional analysis, for example to identify the origin of specific records. Presenting data in the form a search summary table can also provide a user with information about the specificity and recall of each database (see [Bethel et al. 2021](https://doi.org/10.5195/jmla.2021.809) for more about search summary tables.). 
```{r}

```

### Export deduplicated files

```{r}

```


### Generate a search summary table

```{r}

```

